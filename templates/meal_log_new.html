{% extends "base.html" %}

{% block title %}é¥®é£Ÿè®°å½• - å¥èº«é¥®é£Ÿç®¡ç†{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h4 class="mb-0">
                    <i class="fas fa-utensils me-2"></i>é¥®é£Ÿæ™ºèƒ½æ‰“å¡
                </h4>
                <p class="text-muted mb-0">è®°å½•ä½ çš„é¥®é£Ÿæƒ…å†µï¼ŒAIä¼šè‡ªåŠ¨åˆ†æè¥å…»æˆåˆ†å¹¶ä¿å­˜</p>
            </div>
            
            <div class="card-body">
                <form method="POST" id="mealForm">
                    <div class="mb-3">
                        <label for="meal_date" class="form-label">ç”¨é¤æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="meal_date" name="meal_date" required>
                        <div class="form-text">é€‰æ‹©ç”¨é¤çš„æ—¥æœŸ</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meal_type" class="form-label">é¤æ¬¡ç±»å‹</label>
                        <select class="form-select" id="meal_type" name="meal_type" required>
                            <option value="">é€‰æ‹©é¤æ¬¡ç±»å‹</option>
                            <option value="breakfast">æ—©é¤</option>
                            <option value="lunch">åˆé¤</option>
                            <option value="dinner">æ™šé¤</option>
                            <option value="snack">åŠ é¤</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="food_description" class="form-label">
                            <i class="fas fa-apple-alt me-2"></i>æè¿°ä½ çš„é¥®é£Ÿ
                        </label>
                        
                        <!-- è‡ªç„¶è¯­è¨€è¾“å…¥æ–¹å¼ -->
                        <div id="natural-language-input" class="mb-3">
                            <textarea class="form-control" id="food_description" name="food_description" 
                                      rows="4" placeholder="è¯·æè¿°ä½ è¿™é¤åƒçš„é£Ÿç‰©...&#10;&#10;ä¾‹å¦‚ï¼šæ—©é¤åƒäº†ä¸€ä¸ªè‹¹æœï¼Œä¸€ç›’è’™ç‰›ç‰›å¥¶ï¼Œä¸¤ç‰‡å…¨éº¦é¢åŒ…ï¼Œè¿˜æœ‰ä¸€ä¸ªç…è›‹"></textarea>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                ç”¨è‡ªç„¶è¯­è¨€æè¿°å³å¯ï¼ŒAIä¼šè‡ªåŠ¨è¯†åˆ«é£Ÿç‰©ç§ç±»å’Œåˆ†é‡
                            </div>
                        </div>
                        
                        <!-- å¯æŠ˜å çš„æ‰‹åŠ¨è¾“å…¥æ–¹å¼ -->
                        <div class="mb-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" 
                                    data-bs-target="#manual-input-section" aria-expanded="false">
                                <i class="fas fa-list me-1"></i>æ‰‹åŠ¨é€é¡¹è¾“å…¥
                            </button>
                        </div>
                        
                        <div class="collapse" id="manual-input-section">
                            <div class="card card-body">
                                <div id="food-items-container">
                                    <div class="food-item-row mb-2">
                                        <div class="row g-2">
                                            <div class="col-5">
                                                <label class="visually-hidden" for="food_name_0">é£Ÿç‰©åç§°</label>
                                                <input type="text" class="form-control" id="food_name_0" name="food_name[]" placeholder="é£Ÿç‰©åç§°">
                                            </div>
                                            <div class="col-3">
                                                <label class="visually-hidden" for="food_amount_0">æ•°é‡</label>
                                                <input type="number" class="form-control" id="food_amount_0" name="food_amount[]" placeholder="æ•°é‡" min="0.1" step="0.1">
                                            </div>
                                            <div class="col-3">
                                                <label class="visually-hidden" for="food_unit_0">å•ä½</label>
                                                <select class="form-select" id="food_unit_0" name="food_unit[]">
                                                    <option value="å…‹">å…‹</option>
                                                    <option value="ä¸ª">ä¸ª</option>
                                                    <option value="ç‰‡">ç‰‡</option>
                                                    <option value="ç¢—">ç¢—</option>
                                                    <option value="ç›’">ç›’</option>
                                                    <option value="ç“¶">ç“¶</option>
                                                    <option value="æ¯">æ¯</option>
                                                    <option value="å‹º">å‹º</option>
                                                    <option value="æ ¹">æ ¹</option>
                                                    <option value="å—">å—</option>
                                                    <option value="è¢‹">è¢‹</option>
                                                    <option value="ç½">ç½</option>
                                                    <option value="ä»½">ä»½</option>
                                                    <option value="ä¸²">ä¸²</option>
                                                    <option value="é¢—">é¢—</option>
                                                </select>
                                            </div>
                                            <div class="col-1">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-food-item" disabled aria-label="åˆ é™¤é£Ÿç‰©é¡¹">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-outline-success btn-sm" id="add-food-item">
                                    <i class="fas fa-plus me-1"></i>æ·»åŠ é£Ÿç‰©
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨é¤æ„Ÿå— - ç§»åˆ°AIåˆ†ææŒ‰é’®ä¸Šé¢ -->
                    <div class="mb-4">
                        <label for="notes" class="form-label">ç”¨é¤æ„Ÿå— <span class="text-muted">(å¯é€‰)</span></label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="è®°å½•ä»Šå¤©çš„ç”¨é¤æ„Ÿå—ã€å¿ƒæƒ…æˆ–å…¶ä»–æƒ³æ³•..."></textarea>
                    </div>
                    
                    <!-- AIè¥å…»åˆ†ææ‰“å¡æŒ‰é’® -->
                    <div class="d-grid mb-3">
                        <button type="button" class="btn btn-gradient" id="aiNutritionAnalysisSubmit">
                            <i class="fas fa-robot me-2"></i>AIè¥å…»åˆ†ææ‰“å¡
                        </button>
                        <div class="form-text text-center mt-2">AIæ™ºèƒ½åˆ†æè¥å…»å¹¶å®Œæˆé¥®é£Ÿæ‰“å¡</div>
                    </div>
                    
                    <!-- AIåˆ†æç»“æœåŒºåŸŸ -->
                    <div class="mb-3" id="mealResults" style="display: none;">
                        <div id="mealAnalysisLoading" style="display: none;" class="text-center p-4">
                            <div class="spinner-border text-primary me-2"></div>
                            <span class="text-primary">AIæ­£åœ¨åˆ†æè¥å…»æˆåˆ†...</span>
                        </div>
                        
                        <div id="mealAnalysisResults" class="meal-analysis-results">
                            <!-- åŸºç¡€è¥å…»æ•°æ®å¡ç‰‡ -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-gradient-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>è¥å…»æˆåˆ†åˆ†æ
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="nutrition-value text-danger" id="total_calories">0</div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-fire me-1"></i>æ€»çƒ­é‡(kcal)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="nutrition-value text-primary" id="protein_amount">0</div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-drumstick-bite me-1"></i>è›‹ç™½è´¨(g)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="nutrition-value text-warning" id="carbs_amount">0</div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-bread-slice me-1"></i>ç¢³æ°´(g)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="nutrition-value text-info" id="fat_amount">0</div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-cheese me-1"></i>è„‚è‚ª(g)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="nutrition-value text-success" id="fiber_amount">0</div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-seedling me-1"></i>çº¤ç»´(g)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-4">
                                            <div class="nutrition-item">
                                                <div class="meal-score-display">
                                                    <span class="score-value" id="meal_score">0</span>
                                                    <small class="score-max">/10</small>
                                                </div>
                                                <div class="nutrition-label">
                                                    <i class="fas fa-star me-1"></i>è†³é£Ÿè¯„åˆ†
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- è¥å…»è¯„ä¼°å¡ç‰‡ -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-gradient-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-balance-scale me-2"></i>è¥å…»è¯„ä¼°
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="balance-item">
                                        <span class="balance-label">è¥å…»å‡è¡¡:</span>
                                        <span class="balance-value" id="balance_rating">è‰¯å¥½</span>
                                    </div>
                                    <div class="balance-item">
                                        <span class="balance-label">é¤æ¬¡é€‚é…:</span>
                                        <span class="balance-value" id="meal_suitability">é€‚åˆ</span>
                                    </div>
                                    <div class="balance-item">
                                        <span class="balance-label">åˆ†é‡è¯„ä¼°:</span>
                                        <span class="balance-value" id="portion_assessment">é€‚ä¸­</span>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 class="text-success">
                                            <i class="fas fa-thumbs-up me-1"></i>è¥å…»ä¼˜ç‚¹
                                        </h6>
                                        <div id="nutrition_strengths">
                                            <span class="badge bg-success me-1 mb-1">è¥å…»å‡è¡¡</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>æ”¹è¿›å»ºè®®
                                        </h6>
                                        <div id="nutrition_improvements">
                                            <span class="badge bg-warning me-1 mb-1">å¯å¢åŠ è”¬èœ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ä¸ªæ€§åŒ–å»ºè®®å¡ç‰‡ -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-header bg-gradient-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user-md me-2"></i>ä¸ªæ€§åŒ–å»ºè®®
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="recommendation-item">
                                                <h6><i class="fas fa-utensils me-1"></i>ä¸‹é¤å»ºè®®</h6>
                                                <p class="small" id="next_meal_tip">ä¿æŒå‡è¡¡è¥å…»</p>
                                            </div>
                                            <div class="recommendation-item">
                                                <h6><i class="fas fa-lightbulb me-1"></i>ä»Šæ—¥è´´å£«</h6>
                                                <p class="small" id="daily_tip">å¤šæ ·åŒ–é¥®é£Ÿ</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="recommendation-item">
                                                <h6><i class="fas fa-tint me-1"></i>è¡¥æ°´æé†’</h6>
                                                <p class="small" id="hydration_tip">è®°å¾—å¤šå–æ°´</p>
                                            </div>
                                            <div class="recommendation-item">
                                                <h6><i class="fas fa-heart me-1"></i>å¥åº·è¯„ä¼°</h6>
                                                <p class="small" id="health_impact">æ•´ä½“å¥åº·</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3" role="alert">
                                        <i class="fas fa-quote-left me-2"></i>
                                        <span id="motivation_message">è¥å…»æ­é…ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>é¥®é£Ÿå†å²è®°å½•
                </h5>
            </div>
            
            <div class="card-body">
                {% if recent_meals %}
                    <div class="meal-history" id="mealHistory">
                        {% set daily_meals = {} %}
                        {% for meal in recent_meals %}
                            {% set date_key = meal.date.strftime('%Y-%m-%d') %}
                            {% if date_key not in daily_meals %}
                                {% set daily_meals = daily_meals.update({date_key: []}) or daily_meals %}
                            {% endif %}
                            {% set _ = daily_meals.setdefault(date_key, []).append(meal) %}
                        {% endfor %}
                        
                        {% for date_key, meals in daily_meals.items() %}
                        {% set date_obj = meals[0].date %}
                        {% set total_daily_calories = meals|sum(attribute='total_calories') %}
                        
                        <div class="daily-meal-group mb-4" data-date="{{ date_key }}">
                            <!-- æ—¥æœŸå¡ç‰‡å¤´éƒ¨ -->
                            <div class="date-header card border-primary">
                                <div class="card-body p-3 cursor-pointer" onclick="toggleDailyMeals('{{ date_key }}')">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="fas fa-calendar-day text-primary fs-4"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">
                                                        {% if date_obj == today %}
                                                        ğŸ“… ä»Šå¤© ({{ date_obj.strftime('%m-%d') }})
                                                        {% elif (today - date_obj).days == 1 %}
                                                        ğŸ“… æ˜¨å¤© ({{ date_obj.strftime('%m-%d') }})
                                                        {% else %}
                                                        ğŸ“… {{ date_obj.strftime('%m-%d') }}
                                                        {% endif %}
                                                    </h6>
                                                    <small class="text-muted">{{ date_obj.strftime('%A') }}</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-end">
                                                <div class="fw-bold text-danger fs-5">
                                                    <i class="fas fa-fire me-1"></i>{{ total_daily_calories }}
                                                </div>
                                                <small class="text-muted">kcalæ€»è®¡</small>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-chevron-down toggle-icon" id="toggle-icon-{{ date_key }}"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å±•å¼€çš„é¤æ¬¡è¯¦æƒ… -->
                            <div class="daily-meals-content" id="daily-meals-{{ date_key }}" style="display: block;">
                                {% for meal in meals %}
                                <div class="meal-item mt-2 p-3 border rounded" data-meal-id="{{ meal.id }}">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <div class="d-flex align-items-center">
                                                <div class="me-2">
                                                    {% if meal.meal_type == 'breakfast' %}ğŸŒ…
                                                    {% elif meal.meal_type == 'lunch' %}ğŸŒ
                                                    {% elif meal.meal_type == 'dinner' %}ğŸŒ†
                                                    {% else %}ğŸ{% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ meal.meal_type_display }}</h6>
                                                    <div class="text-muted small">
                                                        {{ meal.food_items_summary }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <div class="text-end">
                                                {% if meal.total_calories > 0 %}
                                                <div class="fw-bold text-success">{{ meal.total_calories }} kcal</div>
                                                {% if meal.meal_score > 0 %}
                                                <div class="small text-primary">â­ {{ meal.meal_score }}/10</div>
                                                {% endif %}
                                                {% else %}
                                                <div class="text-muted">â³ åˆ†æä¸­...</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- AIåˆ†ææŠ¥å‘ŠæŒ‰é’® -->
                                    {% if meal.analysis_result and meal.analysis_result != '{' and meal.analysis_result|string|length > 5 %}
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-outline-info btn-sm meal-analysis-btn" 
                                                data-meal-id="{{ meal.id }}" 
                                                data-meal-type="{{ meal.meal_type_display }}" 
                                                data-meal-date="{{ meal.date.strftime('%m-%d') }}"
                                                data-analysis-result="{{ meal.analysis_result|tojson|e }}">
                                            <i class="fas fa-chart-bar me-1"></i>æŸ¥çœ‹AIåˆ†ææŠ¥å‘Š
                                        </button>
                                    </div>
                                    {% elif meal.analysis_result %}
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-outline-warning btn-sm" disabled>
                                            <i class="fas fa-exclamation-triangle me-1"></i>åˆ†ææ•°æ®æŸå
                                        </button>
                                        <small class="text-muted d-block">åŸå§‹æ•°æ®: {{ meal.analysis_result|truncate(50) }}</small>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-utensils fs-1 text-muted mb-3"></i>
                        <p class="text-muted">è¿˜æ²¡æœ‰é¥®é£Ÿè®°å½•</p>
                        <p class="small text-muted">å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€é¤å§ï¼</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- è¥å…»ç›®æ ‡è¿›åº¦å¡ç‰‡ -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-bullseye me-2"></i>ä»Šæ—¥è¥å…»ç›®æ ‡
                </h6>
                <div class="small text-muted">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>ğŸ”¥ çƒ­é‡ç›®æ ‡ (2000 kcal):</span>
                            <span id="daily-calories-progress">0/2000</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-danger" id="calories-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>ğŸ¥© è›‹ç™½è´¨ç›®æ ‡ (80g):</span>
                            <span id="daily-protein-progress">0/80</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-primary" id="protein-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">âš–ï¸ è¥å…»å‡è¡¡åº¦: <span id="nutrition-balance">--</span>%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIåˆ†ææŠ¥å‘Šå¼¹çª—æ¨¡æ€æ¡† -->
<div class="modal fade" id="mealAnalysisModal" tabindex="-1" aria-labelledby="mealAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="mealAnalysisModalLabel">
                    <i class="fas fa-robot me-2"></i>AIè¥å…»åˆ†æè¯¦ç»†æŠ¥å‘Š
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalAnalysisContent">
                <!-- åŠ¨æ€ç”Ÿæˆçš„åˆ†æå†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('meal_date').value = today;
    
    const form = document.getElementById('mealForm');
    const aiSubmitButton = document.getElementById('aiNutritionAnalysisSubmit');
    
    // AIè¥å…»åˆ†ææ‰“å¡å¤„ç†
    aiSubmitButton.addEventListener('click', function() {
        handleAiNutritionCheckin();
    });
    
    // ç»Ÿä¸€AIè¥å…»åˆ†ææ‰“å¡å¤„ç†å‡½æ•°
    async function handleAiNutritionCheckin() {
        // 1. è¡¨å•éªŒè¯
        const mealType = document.getElementById('meal_type').value;
        const mealDate = document.getElementById('meal_date').value;
        const foodDescription = document.getElementById('food_description').value.trim();
        const notes = document.getElementById('notes').value.trim();
        
        // è·å–æ‰‹åŠ¨è¾“å…¥çš„é£Ÿç‰©
        const foodNames = Array.from(document.querySelectorAll('input[name="food_name[]"]')).map(input => input.value.trim());
        const foodAmounts = Array.from(document.querySelectorAll('input[name="food_amount[]"]')).map(input => parseFloat(input.value) || 1);
        const foodUnits = Array.from(document.querySelectorAll('select[name="food_unit[]"]')).map(select => select.value);
        
        const validFoodItems = [];
        for (let i = 0; i < foodNames.length; i++) {
            if (foodNames[i]) {
                validFoodItems.push({
                    name: foodNames[i],
                    amount: foodAmounts[i],
                    unit: foodUnits[i]
                });
            }
        }
        
        if (!mealType || !mealDate) {
            showToast('è¯·é€‰æ‹©é¤æ¬¡ç±»å‹å’Œç”¨é¤æ—¥æœŸ', 'warning');
            return;
        }
        
        if (!foodDescription && validFoodItems.length === 0) {
            showToast('è¯·æè¿°æ‚¨çš„é¥®é£Ÿæˆ–æ‰‹åŠ¨æ·»åŠ é£Ÿç‰©', 'warning');
            return;
        }
        
        // 2. æ˜¾ç¤ºå¤„ç†çŠ¶æ€
        aiSubmitButton.disabled = true;
        aiSubmitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>AIåˆ†æå¹¶ä¿å­˜ä¸­...';
        
        // æ˜¾ç¤ºåˆ†æåŒºåŸŸ
        const mealResults = document.getElementById('mealResults');
        const mealAnalysisLoading = document.getElementById('mealAnalysisLoading');
        mealResults.style.display = 'block';
        mealAnalysisLoading.style.display = 'block';
        
        try {
            // 3. æäº¤è¡¨å•æ•°æ®åˆ°åç«¯ï¼ˆåç«¯ä¼šè‡ªåŠ¨è¿›è¡ŒAIåˆ†æï¼‰
            const formData = new FormData();
            formData.append('meal_date', mealDate);
            formData.append('meal_type', mealType);
            formData.append('food_description', foodDescription);
            formData.append('notes', notes);
            
            // æ·»åŠ æ‰‹åŠ¨è¾“å…¥çš„é£Ÿç‰©é¡¹
            validFoodItems.forEach((item, index) => {
                formData.append('food_name[]', item.name);
                formData.append('food_amount[]', item.amount);
                formData.append('food_unit[]', item.unit);
            });
            
            const response = await fetch('/meal-log', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            if (response.ok) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å®šå‘å“åº”
                if (response.url.includes('/meal-log')) {
                    // æˆåŠŸä¿å­˜ï¼Œé¡µé¢ä¼šé‡æ–°åŠ è½½æ˜¾ç¤ºæ–°è®°å½•
                    showToast('é¥®é£Ÿè®°å½•å·²ä¿å­˜å¹¶å®ŒæˆAIè¥å…»åˆ†æï¼', 'success');
                    
                    // é‡ç½®è¡¨å•
                    resetForm();
                    
                    // éšè—åˆ†æç»“æœåŒºåŸŸ
                    mealResults.style.display = 'none';
                    
                    // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°è®°å½•
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } else {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
            
        } catch (error) {
            console.error('å¤„ç†é”™è¯¯:', error);
            showToast('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error');
            mealAnalysisLoading.style.display = 'none';
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            aiSubmitButton.disabled = false;
            aiSubmitButton.innerHTML = '<i class="fas fa-robot me-2"></i>AIè¥å…»åˆ†ææ‰“å¡';
        }
    }
    
    // é‡ç½®è¡¨å•
    function resetForm() {
        document.getElementById('food_description').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('meal_type').selectedIndex = 0;
        
        // é‡ç½®æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
        const foodNames = document.querySelectorAll('input[name="food_name[]"]');
        const foodAmounts = document.querySelectorAll('input[name="food_amount[]"]');
        const foodUnits = document.querySelectorAll('select[name="food_unit[]"]');
        
        foodNames.forEach(input => input.value = '');
        foodAmounts.forEach(input => input.value = '');
        foodUnits.forEach(select => select.selectedIndex = 0);
    }
    
    // ç®€å•çš„Toasté€šçŸ¥
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'warning'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }
    
    // åŠ¨æ€æ·»åŠ é£Ÿç‰©é¡¹åŠŸèƒ½
    let foodItemIndex = 1;
    
    function updateRemoveButtons() {
        const foodRows = document.querySelectorAll('.food-item-row');
        foodRows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-food-item');
            removeBtn.disabled = foodRows.length <= 1;
        });
    }
    
    document.getElementById('add-food-item').addEventListener('click', function() {
        const container = document.getElementById('food-items-container');
        const newRow = document.createElement('div');
        newRow.className = 'food-item-row mb-2';
        newRow.innerHTML = `
            <div class="row g-2">
                <div class="col-5">
                    <label class="visually-hidden" for="food_name_${foodItemIndex}">é£Ÿç‰©åç§°</label>
                    <input type="text" class="form-control" id="food_name_${foodItemIndex}" name="food_name[]" placeholder="é£Ÿç‰©åç§°">
                </div>
                <div class="col-3">
                    <label class="visually-hidden" for="food_amount_${foodItemIndex}">æ•°é‡</label>
                    <input type="number" class="form-control" id="food_amount_${foodItemIndex}" name="food_amount[]" placeholder="æ•°é‡" min="0.1" step="0.1">
                </div>
                <div class="col-3">
                    <label class="visually-hidden" for="food_unit_${foodItemIndex}">å•ä½</label>
                    <select class="form-select" id="food_unit_${foodItemIndex}" name="food_unit[]">
                        <option value="å…‹">å…‹</option>
                        <option value="ä¸ª">ä¸ª</option>
                        <option value="ç‰‡">ç‰‡</option>
                        <option value="ç¢—">ç¢—</option>
                        <option value="ç›’">ç›’</option>
                        <option value="ç“¶">ç“¶</option>
                        <option value="æ¯">æ¯</option>
                        <option value="å‹º">å‹º</option>
                        <option value="æ ¹">æ ¹</option>
                        <option value="å—">å—</option>
                    </select>
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-food-item" aria-label="åˆ é™¤é£Ÿç‰©é¡¹">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(newRow);
        updateRemoveButtons();
        foodItemIndex++;
    });
    
    // åˆ é™¤é£Ÿç‰©é¡¹åŠŸèƒ½
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-food-item')) {
            const row = e.target.closest('.food-item-row');
            row.remove();
            updateRemoveButtons();
        }
    });
    
    // åˆå§‹åŒ–
    updateRemoveButtons();
    
    // AIåˆ†ææŠ¥å‘ŠæŒ‰é’®äº‹ä»¶ç›‘å¬
    document.addEventListener('click', function(e) {
        if (e.target.closest('.meal-analysis-btn')) {
            const button = e.target.closest('.meal-analysis-btn');
            const mealId = button.getAttribute('data-meal-id');
            const mealType = button.getAttribute('data-meal-type');
            const mealDate = button.getAttribute('data-meal-date');
            const analysisResultStr = button.getAttribute('data-analysis-result');
            
            // æ•°æ®éªŒè¯å’Œæ¸…ç†
            if (!analysisResultStr || analysisResultStr.length < 10) {
                showToast('åˆ†ææ•°æ®ä¸ºç©ºæˆ–è¿‡çŸ­', 'warning');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æŸåçš„JSONï¼ˆåªæœ‰å•ä¸ªå¤§æ‹¬å·ç­‰ï¼‰
            if (analysisResultStr.trim() === '{' || analysisResultStr.trim() === '}') {
                showToast('åˆ†ææ•°æ®æŸåï¼Œè¯·é‡æ–°è¿›è¡ŒAIåˆ†æ', 'warning');
                return;
            }
            
            try {
                let analysisData;
                
                // å¦‚æœæ•°æ®å·²ç»æ˜¯å¯¹è±¡ï¼ˆæŸäº›æƒ…å†µä¸‹å¯èƒ½ç›´æ¥æ˜¯å¯¹è±¡ï¼‰
                if (typeof analysisResultStr === 'object') {
                    analysisData = analysisResultStr;
                } else {
                    // å°è¯•è§£æJSONå­—ç¬¦ä¸²
                    analysisData = JSON.parse(analysisResultStr);
                }
                
                console.log('è§£ææˆåŠŸçš„æ•°æ®:', analysisData);
                showMealAnalysisModal(mealId, analysisData, mealType, mealDate);
                
            } catch (error) {
                console.error('JSONè§£æå¤±è´¥:', error);
                console.error('é—®é¢˜æ•°æ®:', analysisResultStr);
                
                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                showToast('AIåˆ†ææ•°æ®æ ¼å¼æœ‰è¯¯ï¼Œè¯·é‡æ–°è¿›è¡Œåˆ†æ', 'warning');
                
                // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…çš„æ¨¡æ€æ¡†
                const fallbackData = { 
                    error: 'JSONè§£æå¤±è´¥',
                    error_message: error.message,
                    basic_nutrition: { total_calories: 0 },
                    meal_analysis: { meal_score: 0 },
                    raw_data_preview: analysisResultStr.substring(0, 200) + '...'
                };
                showMealAnalysisModal(mealId, fallbackData, mealType, mealDate);
            }
        }
    });
});

// åˆ‡æ¢æ¯æ—¥é¥®é£Ÿè¯¦æƒ…æ˜¾ç¤º
function toggleDailyMeals(dateKey) {
    const content = document.getElementById(`daily-meals-${dateKey}`);
    const icon = document.getElementById(`toggle-icon-${dateKey}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'fas fa-chevron-down toggle-icon';
    } else {
        content.style.display = 'none';
        icon.className = 'fas fa-chevron-right toggle-icon';
    }
}

// æ˜¾ç¤ºAIåˆ†ææŠ¥å‘Šå¼¹çª—
function showMealAnalysisModal(mealId, analysisData, mealType, date) {
    const modal = new bootstrap.Modal(document.getElementById('mealAnalysisModal'));
    const modalTitle = document.getElementById('mealAnalysisModalLabel');
    const modalContent = document.getElementById('modalAnalysisContent');
    
    // è®¾ç½®æ ‡é¢˜
    modalTitle.innerHTML = `<i class="fas fa-robot me-2"></i>AIè¥å…»åˆ†æè¯¦ç»†æŠ¥å‘Š - ${mealType} (${date})`;
    
    // ç”Ÿæˆè¯¦ç»†åˆ†æå†…å®¹
    modalContent.innerHTML = generateDetailedAnalysisHTML(analysisData);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.show();
}

// ç”Ÿæˆè¯¦ç»†åˆ†æHTMLå†…å®¹
function generateDetailedAnalysisHTML(analysis) {
    if (!analysis) {
        return '<div class="text-center p-4"><i class="fas fa-exclamation-triangle text-warning"></i> æš‚æ— åˆ†ææ•°æ®</div>';
    }
    
    // å¦‚æœæœ‰é”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    if (analysis.error) {
        return `
            <div class="alert alert-warning">
                <h6><i class="fas fa-bug me-2"></i>è°ƒè¯•ä¿¡æ¯</h6>
                <p><strong>é”™è¯¯:</strong> ${analysis.error}</p>
                <p><strong>åŸå§‹æ•°æ®:</strong></p>
                <pre class="small">${analysis.raw_data}</pre>
            </div>
        `;
    }
    
    const basicNutrition = analysis.basic_nutrition || {};
    const nutritionBreakdown = analysis.nutrition_breakdown || {};
    const mealAnalysis = analysis.meal_analysis || {};
    const detailedAnalysis = analysis.detailed_analysis || {};
    const personalizedFeedback = analysis.personalized_feedback || {};
    const recommendations = analysis.recommendations || {};
    
    return `
        <!-- åŸºç¡€è¥å…»æ•°æ® -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>è¥å…»æˆåˆ†è¯¦ç»†æ•°æ®</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-danger fs-4">${basicNutrition.total_calories || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-fire me-1"></i>æ€»çƒ­é‡ (kcal)</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-primary fs-4">${basicNutrition.protein || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-drumstick-bite me-1"></i>è›‹ç™½è´¨ (g)</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-warning fs-4">${basicNutrition.carbohydrates || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-bread-slice me-1"></i>ç¢³æ°´åŒ–åˆç‰© (g)</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-info fs-4">${basicNutrition.fat || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-cheese me-1"></i>è„‚è‚ª (g)</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-success fs-4">${basicNutrition.fiber || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-seedling me-1"></i>è†³é£Ÿçº¤ç»´ (g)</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="nutrition-item">
                            <div class="nutrition-value text-secondary fs-4">${basicNutrition.sugar || 0}</div>
                            <div class="nutrition-label"><i class="fas fa-candy-cane me-1"></i>ç³–åˆ† (g)</div>
                        </div>
                    </div>
                </div>
                
                <!-- è¥å…»æ¯”ä¾‹ -->
                <div class="mt-4">
                    <h6><i class="fas fa-chart-bar me-2"></i>è¥å…»æ¯”ä¾‹åˆ†æ</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>ğŸ¥© è›‹ç™½è´¨: ${nutritionBreakdown.protein_percentage || 0}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${nutritionBreakdown.protein_percentage || 0}%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>ğŸ ç¢³æ°´åŒ–åˆç‰©: ${nutritionBreakdown.carbs_percentage || 0}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: ${nutritionBreakdown.carbs_percentage || 0}%"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>ğŸ¥‘ è„‚è‚ª: ${nutritionBreakdown.fat_percentage || 0}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: ${nutritionBreakdown.fat_percentage || 0}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è†³é£Ÿè¯„ä¼° -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-balance-scale me-2"></i>è†³é£Ÿè¯„ä¼°</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center p-3 border rounded">
                            <div class="meal-score-display mb-2">
                                <span class="score-value fs-2 text-primary">${mealAnalysis.meal_score || 0}</span>
                                <small class="score-max fs-5">/10</small>
                            </div>
                            <small class="text-muted">è†³é£Ÿè¯„åˆ†</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="balance-item">
                            <strong>è¥å…»å‡è¡¡:</strong> ${mealAnalysis.balance_rating || 'è‰¯å¥½'}
                        </div>
                        <div class="balance-item">
                            <strong>é¤æ¬¡é€‚é…:</strong> ${mealAnalysis.meal_type_suitability || 'é€‚åˆ'}
                        </div>
                        <div class="balance-item">
                            <strong>åˆ†é‡è¯„ä¼°:</strong> ${mealAnalysis.portion_assessment || 'é€‚ä¸­'}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†åˆ†æ -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-search me-2"></i>è¯¦ç»†åˆ†æ</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success"><i class="fas fa-thumbs-up me-1"></i>è¥å…»ä¼˜ç‚¹</h6>
                        <ul class="list-unstyled">
                            ${(detailedAnalysis.strengths || []).map(strength => 
                                `<li><i class="fas fa-check text-success me-2"></i>${strength}</li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>æ”¹è¿›å»ºè®®</h6>
                        <ul class="list-unstyled">
                            ${(detailedAnalysis.areas_for_improvement || []).map(improvement => 
                                `<li><i class="fas fa-arrow-up text-warning me-2"></i>${improvement}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸ªæ€§åŒ–åé¦ˆ -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>ä¸ªæ€§åŒ–åé¦ˆ</h6>
            </div>
            <div class="card-body">
                <div class="feedback-item">
                    <strong>ğŸ”¥ çƒ­é‡è¯„ä¼°:</strong> ${personalizedFeedback.calorie_assessment || 'çƒ­é‡é€‚ä¸­'}
                </div>
                <div class="feedback-item">
                    <strong>âš–ï¸ å®é‡è¥å…»:</strong> ${personalizedFeedback.macro_balance || 'è¥å…»æ¯”ä¾‹åˆç†'}
                </div>
                <div class="feedback-item">
                    <strong>ğŸ’– å¥åº·å½±å“:</strong> ${personalizedFeedback.health_impact || 'æœ‰ç›Šå¥åº·'}
                </div>
            </div>
        </div>
        
        <!-- ä¸“ä¸šå»ºè®® -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>ä¸“ä¸šå»ºè®®</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="recommendation-item">
                            <h6><i class="fas fa-utensils me-1"></i>ä¸‹é¤å»ºè®®</h6>
                            <p class="small">${recommendations.next_meal_suggestion || 'ä¿æŒå‡è¡¡è¥å…»'}</p>
                        </div>
                        <div class="recommendation-item">
                            <h6><i class="fas fa-lightbulb me-1"></i>ä»Šæ—¥è´´å£«</h6>
                            <p class="small">${recommendations.daily_nutrition_tip || 'å¤šæ ·åŒ–é¥®é£Ÿ'}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="recommendation-item">
                            <h6><i class="fas fa-tint me-1"></i>è¡¥æ°´æé†’</h6>
                            <p class="small">${recommendations.hydration_reminder || 'è®°å¾—å¤šå–æ°´'}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ¿€åŠ±ä¿¡æ¯ -->
        <div class="alert alert-info" role="alert">
            <div class="text-center">
                <i class="fas fa-quote-left me-2"></i>
                <strong>${analysis.motivation_message || 'è¥å…»æ­é…ä¸é”™ï¼Œç»§ç»­ä¿æŒå¥åº·é¥®é£Ÿï¼'}</strong>
                <i class="fas fa-quote-right ms-2"></i>
            </div>
        </div>
    `;
}
</script>
{% endblock %}