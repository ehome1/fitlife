{% extends "base.html" %}

{% block title %}进度分析 - 健身饮食管理{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-chart-line me-2"></i>进度分析
        </h2>
        <p class="text-muted">通过数据可视化了解你的健身和饮食趋势</p>
    </div>
</div>

<!-- 时间范围选择 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label class="form-label mb-0">时间范围：</label>
                    </div>
                    <div class="col">
                        <select class="form-select" id="dateRange">
                            <option value="7">最近一周</option>
                            <option value="30" selected>最近一月</option>
                            <option value="90">最近三月</option>
                            <option value="365">最近一年</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-outline-primary" id="refreshCharts">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 数据统计卡片 -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="mb-2">
                <i class="fas fa-fire text-danger fs-3"></i>
            </div>
            <div class="stat-number">{{ stats.total_burned }}</div>
            <div class="text-muted">总消耗 (kcal)</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="mb-2">
                <i class="fas fa-utensils text-success fs-3"></i>
            </div>
            <div class="stat-number">{{ stats.total_consumed }}</div>
            <div class="text-muted">总摄入 (kcal)</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="mb-2">
                <i class="fas fa-dumbbell text-primary fs-3"></i>
            </div>
            <div class="stat-number">{{ stats.exercise_days }}</div>
            <div class="text-muted">运动天数</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="mb-2">
                <i class="fas fa-clock text-warning fs-3"></i>
            </div>
            <div class="stat-number">{{ stats.total_minutes }}</div>
            <div class="text-muted">运动时长 (分钟)</div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row g-4">
    <!-- 热量平衡趋势图 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>热量平衡趋势
                </h5>
                <p class="text-muted small mb-0">每日热量摄入与消耗对比</p>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="calorieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 运动强度分布 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>运动强度分布
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="intensityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 营养成分分析 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-chart-radar me-2"></i>营养成分分析
                </h5>
                <p class="text-muted small mb-0">蛋白质、碳水化合物、脂肪摄入比例</p>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="nutritionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 运动类型分析 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>运动类型分析
                </h5>
                <p class="text-muted small mb-0">不同运动类型的时长和频次</p>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="exerciseTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 打卡热力图 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check me-2"></i>打卡热力图
                </h5>
                <p class="text-muted small mb-0">每日打卡活跃度，颜色越深表示打卡次数越多</p>
            </div>
            <div class="card-body">
                <div id="heatmapChart" class="text-center">
                    <!-- 热力图将通过JavaScript生成 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细数据表格 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>详细数据
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>运动次数</th>
                                <th>运动时长</th>
                                <th>消耗热量</th>
                                <th>饮食记录</th>
                                <th>摄入热量</th>
                                <th>热量平衡</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- 数据将通过JavaScript填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 准备数据
const exercises = {{ exercises_data|tojson }};
const meals = {{ meals_data|tojson }};

// 初始化所有图表
let calorieChart, intensityChart, nutritionChart, exerciseTypeChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    updateStatistics();
    generateHeatmap();
    fillDataTable();
    
    // 监听时间范围变化
    document.getElementById('dateRange').addEventListener('change', function() {
        const selectedDays = this.value;
        window.location.href = `/progress?days=${selectedDays}`;
    });
    
    document.getElementById('refreshCharts').addEventListener('click', function() {
        window.location.reload();
    });
});

function initializeCharts() {
    // 热量平衡趋势图
    const calorieCtx = document.getElementById('calorieChart').getContext('2d');
    calorieChart = new Chart(calorieCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '消耗热量',
                data: [],
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: true
            }, {
                label: '摄入热量',
                data: [],
                borderColor: 'rgb(25, 135, 84)',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '热量 (kcal)'
                    }
                }
            }
        }
    });
    
    // 运动强度分布
    const intensityCtx = document.getElementById('intensityChart').getContext('2d');
    intensityChart = new Chart(intensityCtx, {
        type: 'doughnut',
        data: {
            labels: ['低强度', '中等强度', '高强度'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 营养成分分析
    const nutritionCtx = document.getElementById('nutritionChart').getContext('2d');
    nutritionChart = new Chart(nutritionCtx, {
        type: 'radar',
        data: {
            labels: ['蛋白质', '碳水化合物', '脂肪'],
            datasets: [{
                label: '营养摄入 (g)',
                data: [0, 0, 0],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgb(54, 162, 235)',
                pointBackgroundColor: 'rgb(54, 162, 235)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // 运动类型分析
    const exerciseTypeCtx = document.getElementById('exerciseTypeChart').getContext('2d');
    exerciseTypeChart = new Chart(exerciseTypeCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '运动时长 (分钟)',
                data: [],
                backgroundColor: 'rgba(102, 126, 234, 0.8)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '时长 (分钟)'
                    }
                }
            }
        }
    });
}

function updateCharts() {
    const days = parseInt(document.getElementById('dateRange').value);
    const endDate = new Date();
    const startDate = new Date(endDate);
    startDate.setDate(startDate.getDate() - days);
    
    // 过滤数据
    const filteredExercises = exercises.filter(ex => {
        const exDate = new Date(ex.date);
        return exDate >= startDate && exDate <= endDate;
    });
    
    const filteredMeals = meals.filter(meal => {
        const mealDate = new Date(meal.date);
        return mealDate >= startDate && mealDate <= endDate;
    });
    
    // 更新热量图表
    updateCalorieChart(filteredExercises, filteredMeals);
    
    // 更新强度分布
    updateIntensityChart(filteredExercises);
    
    // 更新营养图表
    updateNutritionChart(filteredMeals);
    
    // 更新运动类型图表
    updateExerciseTypeChart(filteredExercises);
    
    updateStatistics();
}

function updateCalorieChart(filteredExercises, filteredMeals) {
    // 按日期分组计算热量
    const dailyData = {};
    
    filteredExercises.forEach(ex => {
        if (!dailyData[ex.date]) {
            dailyData[ex.date] = { burned: 0, consumed: 0 };
        }
        dailyData[ex.date].burned += ex.calories_burned || 0;
    });
    
    filteredMeals.forEach(meal => {
        if (!dailyData[meal.date]) {
            dailyData[meal.date] = { burned: 0, consumed: 0 };
        }
        dailyData[meal.date].consumed += meal.calories || 0;
    });
    
    const dates = Object.keys(dailyData).sort();
    const burnedData = dates.map(date => dailyData[date].burned);
    const consumedData = dates.map(date => dailyData[date].consumed);
    
    calorieChart.data.labels = dates;
    calorieChart.data.datasets[0].data = burnedData;
    calorieChart.data.datasets[1].data = consumedData;
    calorieChart.update();
}

function updateIntensityChart(filteredExercises) {
    const intensityCount = { low: 0, medium: 0, high: 0 };
    
    filteredExercises.forEach(ex => {
        if (ex.intensity && intensityCount.hasOwnProperty(ex.intensity)) {
            intensityCount[ex.intensity]++;
        }
    });
    
    intensityChart.data.datasets[0].data = [
        intensityCount.low,
        intensityCount.medium,
        intensityCount.high
    ];
    intensityChart.update();
}

function updateNutritionChart(filteredMeals) {
    let totalProtein = 0, totalCarbs = 0, totalFat = 0;
    
    filteredMeals.forEach(meal => {
        totalProtein += meal.protein || 0;
        totalCarbs += meal.carbs || 0;
        totalFat += meal.fat || 0;
    });
    
    nutritionChart.data.datasets[0].data = [totalProtein, totalCarbs, totalFat];
    nutritionChart.update();
}

function updateExerciseTypeChart(filteredExercises) {
    const typeCount = {};
    
    filteredExercises.forEach(ex => {
        if (!typeCount[ex.exercise_type]) {
            typeCount[ex.exercise_type] = 0;
        }
        typeCount[ex.exercise_type] += ex.duration || 0;
    });
    
    const types = Object.keys(typeCount);
    const durations = types.map(type => typeCount[type]);
    
    exerciseTypeChart.data.labels = types;
    exerciseTypeChart.data.datasets[0].data = durations;
    exerciseTypeChart.update();
}

function updateStatistics() {
    // 统计数据由后端提供，这里不需要重新计算
    console.log('统计数据由后端提供');
}

function generateHeatmap() {
    const heatmapContainer = document.getElementById('heatmapChart');
    
    // 创建简单的ASCII样式热力图
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - 90); // 显示最近90天
    
    let heatmapHTML = '<div class="heatmap-grid" style="font-family: monospace; line-height: 1.2;">';
    
    // 创建表头 (月份)
    heatmapHTML += '<div class="mb-2"><small class="text-muted">最近90天打卡活跃度：</small></div>';
    
    // 创建网格
    for (let week = 0; week < 13; week++) {
        heatmapHTML += '<div class="d-flex" style="gap: 2px; margin-bottom: 2px;">';
        for (let day = 0; day < 7; day++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + (week * 7) + day);
            
            if (currentDate > today) {
                heatmapHTML += '<div style="width: 12px; height: 12px; background: #eee; border-radius: 2px;"></div>';
            } else {
                // 模拟活跃度数据
                const activity = Math.floor(Math.random() * 5);
                let color = '#ebedf0';
                if (activity === 1) color = '#c6e48b';
                else if (activity === 2) color = '#7bc96f';
                else if (activity === 3) color = '#239a3b';
                else if (activity === 4) color = '#196127';
                
                heatmapHTML += `<div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;" title="${currentDate.toLocaleDateString()}: ${activity}次打卡"></div>`;
            }
        }
        heatmapHTML += '</div>';
    }
    
    heatmapHTML += '<div class="mt-2"><small class="text-muted">颜色越深表示打卡次数越多</small></div>';
    heatmapHTML += '</div>';
    
    heatmapContainer.innerHTML = heatmapHTML;
}

function fillDataTable() {
    const tableBody = document.getElementById('dataTable');
    
    if (exercises.length === 0 && meals.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>';
        return;
    }
    
    // 按日期分组数据
    const dailyData = {};
    
    exercises.forEach(ex => {
        if (!dailyData[ex.date]) {
            dailyData[ex.date] = {
                exerciseCount: 0,
                exerciseDuration: 0,
                caloriesBurned: 0,
                mealCount: 0,
                caloriesConsumed: 0
            };
        }
        dailyData[ex.date].exerciseCount++;
        dailyData[ex.date].exerciseDuration += ex.duration || 0;
        dailyData[ex.date].caloriesBurned += ex.calories_burned || 0;
    });
    
    meals.forEach(meal => {
        if (!dailyData[meal.date]) {
            dailyData[meal.date] = {
                exerciseCount: 0,
                exerciseDuration: 0,
                caloriesBurned: 0,
                mealCount: 0,
                caloriesConsumed: 0
            };
        }
        dailyData[meal.date].mealCount++;
        dailyData[meal.date].caloriesConsumed += meal.calories || 0;
    });
    
    // 生成表格行
    const dates = Object.keys(dailyData).sort().reverse(); // 最新日期在前
    let tableHTML = '';
    
    dates.forEach(date => {
        const data = dailyData[date];
        const balance = data.caloriesConsumed - data.caloriesBurned;
        const balanceClass = balance > 0 ? 'text-warning' : 'text-success';
        
        tableHTML += `
            <tr>
                <td>${date}</td>
                <td><span class="badge bg-primary">${data.exerciseCount}</span></td>
                <td>${data.exerciseDuration}分钟</td>
                <td class="text-danger fw-bold">${data.caloriesBurned}</td>
                <td><span class="badge bg-success">${data.mealCount}</span></td>
                <td class="text-success fw-bold">${data.caloriesConsumed}</td>
                <td class="${balanceClass} fw-bold">${balance > 0 ? '+' : ''}${balance}</td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = tableHTML;
}

// 初始化时更新图表
setTimeout(updateCharts, 100);

// 设置当前选中的时间范围
const urlParams = new URLSearchParams(window.location.search);
const currentDays = urlParams.get('days') || '30';
document.getElementById('dateRange').value = currentDays;
</script>
{% endblock %}